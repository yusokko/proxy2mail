name: Proxy-Repo to Mail
on:
  schedule:
    - cron: '5 10 * * *'          # UTC 12:05 = åŒ—äº¬æ—¶é—´ 20:05
  workflow_dispatch:              # æ‰‹åŠ¨è§¦å‘æŒ‰é’®
jobs:
  mail:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: æŠ“å–ç›®æ ‡ä»“åº“
        uses: actions/checkout@v2
        with:
          repository: crossxx-labs/free-proxy   # è¦æŠ“çš„ä»“åº“
          path: proxy                           # æ”¾åˆ° ./proxy ç›®å½•

      - name: ç”Ÿæˆæ‘˜è¦æ–‡ä»¶
        run: |
          echo "# å…è´¹ä»£ç†ä»“åº“æ¯æ—¥å¿«ç…§" > summary.md
          echo "## æ›´æ–°æ—¶é—´ï¼š$(date -d '8 hour' '+%F %T')" >> summary.md
          echo "" >> summary.md
          echo "### ç›®å½•ç»“æ„" >> summary.md
          #tree proxy -a >> summary.md
          echo "" >> summary.md
          echo "### READMEå†…å®¹" >> summary.md
          cat proxy/README.md >> summary.md
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "æ–‡ä»¶æ˜¯å¦å­˜åœ¨:"
          ls -l summary.md
          echo "å‰ 3 è¡Œå†…å®¹:"
          head -3 summary.md
        
      - name: ğŸ” éªŒè¯é‚®ç®±å˜é‡ï¼ˆä¸ä¼šæ³„éœ²å€¼ï¼‰
        run: |
          echo "MAIL_USERé•¿åº¦: ${#MAIL_USER}"
          echo "MAIL_TOé•¿åº¦: ${#MAIL_TO}"
          echo "MAIL_PASSé•¿åº¦: ${#MAIL_PASS}"
          if [[ -z "$MAIL_USER" || -z "$MAIL_PASS" || -z "$MAIL_TO" ]]; then
            echo "âŒ å­˜åœ¨ç©ºå˜é‡ï¼Œè¯·æ£€æŸ¥ Repository Secretsï¼"
            exit 1
          fi
          echo "âœ… å˜é‡æ ¼å¼OK"
        env:
          MAIL_USER: ${{ secrets.MAIL_USER }}
          MAIL_PASS: ${{ secrets.MAIL_PASS }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
          
      - name: å‘é€åˆ°é‚®ç®±
        uses: dawidd6/action-send-mail@v2
        with:
          server_address: smtp.163.com
          server_port: 465
          username: ${{ secrets.MAIL_USER }}
          password: ${{ secrets.MAIL_PASS }}
          subject: "ğŸ†“ å…è´¹ä»£ç†ä»“åº“å¿«ç…§ $(date -d '8 hour' '+%m%d %H:%M')"
          to: ${{ secrets.MAIL_TO }}
          #from: GitHub Actions 
          from: ${{ secrets.MAIL_USER }}      # â† å¿…é¡»æ˜¾å¼ç»™ from
          body: file://summary.md
          #convert_markdown: true              # â† ç”¨å†…ç½®å¼€å…³ä»£æ›¿ content_type
          #secure: true
